---
title: "Analyzing web of life data"
author: "Saint-Clair Chabert-Liddell"
date: "9/20/2021"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning=FALSE, message=FALSE, fig.width=7, fig.retina = 2, fig.height = 5,
  comment = "#>"
)
```

```{r setup}
library(robber)
library(ggplot2)
library(purrr)
library(tibble)
library(dplyr)
library(stringr)
library(tidyr)
```

We load a collection of all the Seed-Dispersal, Host-Parasite and Plant-Pollinator
of the Web of Life dataset (www.web-of-life.es). All networks have been binarized.
```{r importdatabase}
my_files <- dir(path = "data/")
my_files <- my_files[1:(length(my_files)-2)]
web_of_life <- lapply(
  X = seq_along(my_files),
  FUN = function(i) {
    df <- read.csv(file = paste0("data/",
                                 my_files[i]), header = TRUE, row.names = 1)
    A <- as.matrix(df)
    if (stringr::str_sub(my_files[i], 1, 4) == "A_HP") {
      A <- A[,2:ncol(A)]
    }
    A[A!=0] <- 1
    return(list(
      net = A,
      nr = nrow(A),
      nc = ncol(A),
      dens = mean(A),
      id = stringr::str_sub(my_files[i], 1, -5))
    )
  }
)
```

For all these bipartite networks, we will compute the empirical robustness and
the robustness by block model and its variance for uniform extinction sequences.
For example:
```{r 100}
rob_emp <- robustness_emp(web_of_life[[100]]$net)
param <- get_lbm_param(web_of_life[[100]]$net)
rob_bm <- do.call(robustness_lbm, param)
var_rob <- do.call(var_auc_unif_lbm, param)
tb_robustness <- tibble::tibble( 
                    id = web_of_life[[100]]$id,
                    Empirical = rob_emp$auc, 
                    BM = rob_bm$auc, 
                    Variance = var_rob,
                    nr = web_of_life[[100]]$nr,
                    nc = web_of_life[[100]]$nc,
                    dens = web_of_life[[100]]$dens)

print(tb_robustness)
```

And compare the robustness the empirical and Block Model robustness function:
```{r plot100}
ggplot2::ggplot(data.frame(x = seq(0, tb_robustness$nr)/tb_robustness$nr,
                           Empirical = rob_emp$fun,
                           BM = rob_bm$fun),
                ggplot2::aes(x = x, y = Empirical)) +
  ggplot2::geom_step(col = "red") + 
  ggplot2::geom_step(ggplot2::aes(y = BM), linetype = "dashed", col = "blue")
```

```{r}
p_em_col <- 1-(1-param$pi %*% param$con)**param$nr
p_em_row <- 1 -(1-param$con %*% param$rho)**param$nc
nr_tilde <- (param$pi*param$nr)/p_em_row
nc_tilde <- (param$rho*param$nc)/p_em_col
param_tilde <- list(con = param$con,
                    pi = as.vector(nr_tilde/sum(nr_tilde)),
                    rho = as.vector(nc_tilde/sum(nc_tilde)),
#                    rho = param$rho,
                    nr = ceiling(sum(nr_tilde)),
                    nc = ceiling(sum(nc_tilde)))
while (any(p_em_row < 1-1e-3) | any(p_em_col < 1-1e-3) ) {
  p_em_col <- 1 - (1 - param_tilde$pi %*% param_tilde$con)**param_tilde$nr
  p_em_row <- 1 - (1 - param_tilde$con %*% param_tilde$rho)**param_tilde$nc
  print(p_em_col)
  print(p_em_row)
  nr_tilde <- (param_tilde$pi*param_tilde$nr)/p_em_row
  nc_tilde <- (param_tilde$rho*param_tilde$nc)/p_em_col
  param_tilde <- list(con = param$con,
                    pi = as.vector(nr_tilde/sum(nr_tilde)),
                    rho = as.vector(nc_tilde/sum(nc_tilde)),
#                    rho = param$rho,
                    nr = ceiling(sum(nr_tilde)),
                    nc = ceiling(sum(nc_tilde)))
}
param_tilde

nr_tilde <- (param$pi*param$nr)/p_em_row
nc_tilde <- (param$rho*param$nc)/p_em_col
param_tilde <- list(con = param$con,
                    pi = as.vector(nr_tilde/sum(nr_tilde)),
                    rho = as.vector(nc_tilde/sum(nc_tilde)),
#                    rho = param$rho,
                    nr = ceiling(sum(nr_tilde)),
                    nc = ceiling(sum(nc_tilde)))

rob_norm <- do.call( robustness_lbm, param_tilde)
```
```{r idee_sophie}
tb_rob = tibble()
for ( i in seq_along(web_of_life)) {
  if (web_of_life[[i]]$nr < 100 & web_of_life[[i]]$nc <100) {
    A <- web_of_life[[i]]$net
    param <- get_lbm_param(A)
    rob_emp <- robustness_emp(A)
    rob_bm <- do.call(robustness_lbm, param)
    nc_new <-  param$nc/(1-(1-param$pi %*% param$con)**param$nr %*% param$rho) -param$nc
    nr_new <- param$nr/(1 - param$pi %*% (1-param$con %*% param$rho)**param$nc ) -param$nr
    A_new <- rbind(A, matrix(0, ceiling(nr_new), ncol(A)))
    A_new <- cbind(A_new, matrix(0, nrow(A_new), ceiling(nc_new)))
    
    param_new <- get_lbm_param(A_new)
    rob_emp_new <- robustness_emp(A_new)
    rob_bm_new <- do.call(robustness_lbm, param_new)
    tb_rob <- bind_rows(
      tb_rob, 
      tibble(id = i, 
             rob_bm = rob_bm$auc, 
             rob_emp = rob_emp$auc,
             rob_bm_new = rob_bm_new$auc,
             rob_emp_new = rob_emp_new$auc))  
  } 
}

```

```{r}
tb_rob %>% summarise(old = mean(abs(rob_bm - rob_emp)),
                     new = mean(abs(rob_bm_new - rob_emp_new)),
                     bm = mean(abs(rob_bm - rob_bm_new)),
                     emp = mean(abs(rob_bm - rob_emp_new)),
                     bm_new = mean(abs(rob_bm - rob_emp_new)),
                     improve = mean(abs(rob_bm - rob_emp) > abs(rob_bm_new - rob_emp_new)),
                     max_upgrade = max(abs(rob_bm - rob_emp) - abs(rob_bm_new - rob_emp_new)),
                    max_downgrade = min(abs(rob_bm - rob_emp) - abs(rob_bm_new - rob_emp_new)))
```

```{r plotnorm}
ggplot2::ggplot(data.frame(x = seq(0, tb_robustness$nr)/tb_robustness$nr,
                           Empirical = rob_emp$fun,
                           BM = rob_bm$fun),
                ggplot2::aes(x = x, y = Empirical)) +
  ggplot2::geom_step(col = "red") + 
  ggplot2::geom_step(ggplot2::aes(y = BM), linetype = "dashed", col = "blue") +
  annotate("step", x = seq(0, param_tilde$nr)/param_tilde$nr,
          y = rob_norm$fun)
```


We can also compute the robustness by block model for other extinctions sequences:
```{r}
rob_emp_inc <- robustness_emp(web_of_life[[100]]$net, 
                              ext_seq = "increasing")
rob_emp_dec <- robustness_emp(web_of_life[[100]]$net,
                              ext_seq = "decreasing")
rob_bm_inc <- do.call(robustness_lbm, c(param, ext_seq = "increasing"))
rob_bm_dec <- do.call(robustness_lbm, c(param, ext_seq = "decreasing"))
print(c(rob_bm_dec$auc, rob_bm$auc, rob_bm_inc$auc))
```
```{r}
ggplot2::ggplot(data.frame(x = seq(0, tb_robustness$nr)/tb_robustness$nr,
                           Empirical = rob_emp_inc$fun,
                           BM = rob_bm_inc$fun),
                ggplot2::aes(x = x, y = Empirical)) +
  ggplot2::geom_step(col = "red") + 
  ggplot2::geom_step(ggplot2::aes(y = BM/BM[1]), linetype = "dashed", col = "blue")
```
```{r}
par <- list(con = matrix(c(.5, .1),2,1), pi = c(1/3, 2/3), rho = 1, nr = 5, nc = 100)
matrix(flatten_dbl(lapply(seq(50), function(i) {robustness_emp(do.call(simulate_lbm, c(par[1:5]))$A,  ext_seq = "increasing")$fun})), ncol = 6, byrow = TRUE) %>% 
  colMeans() %T>% print() %>% mean()
robustness_lbm(con = matrix(c(.5, .1),2,1), pi = c(1/3, 2/3), rho = 1, nr = 5, nc = 100, ext_seq = "increasing")
```

```{r}
ggplot2::ggplot(data.frame(x = seq(0, tb_robustness$nr)/tb_robustness$nr,
                           Empirical = rob_emp_inc$fun,
                           BM = rob_bm_inc$fun),
                ggplot2::aes(x = x, y = Empirical)) +
  ggplot2::geom_step(col = "red") + 
  ggplot2::geom_step(ggplot2::aes(y = BM/BM[1]), linetype = "dashed", col = "blue")
```

```{r}
ggplot2::ggplot(data.frame(x = seq(0, tb_robustness$nr)/tb_robustness$nr,
                           Empirical = rob_emp_dec$fun,
                           BM = rob_bm_dec$fun),
                ggplot2::aes(x = x, y = Empirical)) +
  ggplot2::geom_step(col = "red") + 
  ggplot2::geom_step(ggplot2::aes(y = BM/BM[1]), linetype = "dashed", col = "blue")
```

```{r}
ext_seq <-c("uniform", "decreasing", "increasing") 
if(! file.exists("empirical_robustness.rds")) {
rob_emp <- pbmcapply::pbmclapply(
  X = seq_along(web_of_life), 
  FUN = function(i) {
    tb <- map_dfc(.x = ext_seq,
            .f = function(ext) {
                 robustness_emp(web_of_life[[i]]$net, 
                                          ext_seq = ext,
                                          nb_iter = min(300, 2*web_of_life[[i]]$nr))$auc}) %>% 
       set_names(paste0(ext_seq, ".emp.lin"))
    ext_seq <-c("decreasing", "increasing") 
    tb_ord <- map_dfc(.x = ext_seq,
            .f = function(ext) {
                 robustness_emp(web_of_life[[i]]$net, 
                                          ext_seq = ext,
                                          nb_iter = min(300, 2*web_of_life[[i]]$nr), method = "ordered")$auc}) %>% 
       set_names(paste0(ext_seq, ".emp.ord"))
    return(bind_cols(tb, tb_ord) %>% mutate(id = web_of_life[[i]]$id, .before = 1))
  }, mc.cores = 10L)
rob_emp <- bind_rows(rob_emp)
saveRDS(rob_emp, "empirical_robustness.rds")
}
rob_emp <- readRDS(file = "empirical_robustness.rds")

```

```{r}
if(! file.exists("wol_lbm_parameters.rds")) {
  nb_cores <- parallel::detectCores()/2
  if (is.null(nb_cores)) nb_cores <- 1
  lbm_par <- pbmcapply::pbmclapply(
    X = seq_along(web_of_life), 
    FUN = function(i) {
      llll <- get_lbm_param(web_of_life[[i]]$net)
      llll <- c(llll, QR = length(llll$pi), QC = length(llll$rho))
      return(llll)
    }, mc.cores = nb_cores)
  saveRDS(lbm_par, "wol_lbm_parameters.rds")
}
lbm_par <- readRDS(file = "wol_lbm_parameters.rds")
```
```{r comp_tb_rob_wol}
if (! file.exists("./tb_robustness_wol.rds"))
{
  nb_cores <- parallel::detectCores()/2
  if (is.null(nb_cores)) nb_cores <- 1
  tb_robustness_wol <- pbmcapply::pbmclapply(
    X = seq_along(web_of_life),
    FUN = function(i) {
#      if (web_of_life[[i]]$nr > 250) return(NULL)
#      rob_emp <- robustness_emp(web_of_life[[i]]$net)$auc
      param <- lbm_par[[i]][1:5]
      rob_bm <- do.call(robustness_lbm, param)$auc
      rob_bm_inc <- do.call(robustness_lbm, c(param, ext_seq = "increasing"))$auc
      rob_bm_dec <- do.call(robustness_lbm, c(param, ext_seq = "decreasing"))$auc
      rob_bm_inc_noz <- do.call(robustness_lbm, c(param, ext_seq = "increasing", method = "no_empty_block"))$auc
      rob_bm_dec_noz <- do.call(robustness_lbm, c(param, ext_seq = "decreasing", method = "no_empty_block"))$auc
      rob_bm_inc_exp <- do.call(robustness_lbm, c(param, ext_seq = "increasing", method = "expected"))$auc
      rob_bm_dec_exp <- do.call(robustness_lbm, c(param, ext_seq = "decreasing", method = "expected"))$auc
      bm_blocks <- do.call(robustness_lbm, c(param, ext_seq = "blocks"))
      bm_blocks_noz <- do.call(robustness_lbm, c(param, ext_seq = "blocks", 
                                                 method = "no_empty_block"))
      bm_blocks_exp <- do.call(robustness_lbm, c(param, ext_seq = "blocks", 
                                                 method = "expected"))
      rob_bm_min <- min(map_dbl(bm_blocks, "auc"))
      rob_bm_max <- max(map_dbl(bm_blocks, "auc"))
      rob_bm_min_noz <- min(map_dbl(bm_blocks_noz, "auc"))
      rob_bm_max_noz <- max(map_dbl(bm_blocks_noz, "auc"))
      rob_bm_min_exp <- min(map_dbl(bm_blocks_exp, "auc"))
      rob_bm_max_exp <- max(map_dbl(bm_blocks_exp, "auc"))
      var_rob <- do.call(var_auc_unif_lbm, param)
      tb_tmp <- tibble::tibble(
        id = web_of_life[[i]]$id, 
#        Empirical = rob_emp, 
        bm.unif = rob_bm, 
        Variance = var_rob,
        nr = web_of_life[[i]]$nr,
        nc = web_of_life[[i]]$nc,
        dens = web_of_life[[i]]$dens,
        bm.inc = rob_bm_inc,
        bm.dec = rob_bm_dec,
        bm.min = rob_bm_min,
        bm.max = rob_bm_max,
        bm.inc.noz = rob_bm_inc_noz,
        bm.dec.noz = rob_bm_dec_noz,
        bm.min.noz = rob_bm_min_noz,
        bm.max.noz = rob_bm_max_noz,
        bm.inc.exp = rob_bm_inc_exp,
        bm.dec.exp = rob_bm_dec_exp,
        bm.min.exp = rob_bm_min_exp,
        bm.max.exp = rob_bm_max_exp,
        K = nrow(param$con),
        Q = ncol(param$con)
      )
      return(tb_tmp)
    }, mc.cores = nb_cores
  )
  tb_robustness_wol <- dplyr::bind_rows(tb_robustness_wol)
  saveRDS(tb_robustness_wol, "./tb_robustness_wol.rds")
} else {
  tb_robustness_wol <- readRDS(file = "data/tb_robustness_wol.rds")
}


```

```{r}
tb_robustness_wol <- rob_emp %>% inner_join(tb_robustness_wol)
tb_robustness_wol <- tb_robustness_wol %>% mutate(tmp = bm.inc.exp, bm.inc.exp = bm.dec.exp, bm.dec.exp = tmp) %>% select(-tmp)
```


```{r}
#tb_robustness_wol <- bind_rows(map(seq_along(tb_robustness_wol), ~ if(is_tibble(tb_robustness_wol[[.x]])) tb_robustness_wol[[.x]]))
# tb_robustness_wol %>% 
#   mutate("# Std Deviation" = abs(uniform.emp.lin - bm.unif)/sqrt(Variance),
#          "Empty Column" = (1-dens)**nr) %>% 
#   filter(nr >10 & nc >10) %>% 
#   filter(! str_sub(id, 3, 4) %in% c("DS", "LP")) %>% 
#   group_by(`# Std Deviation`,   
#            `Empty Column`) %>% 
#   ggplot(aes(y = abs(Empirical - BM)/Empirical,  
#              x = `Empty Column`)) +
#   geom_point()

```
```{r}
#lbm_param <- readRDS("wol_lbm_parameters.rds")
pbiso <- map_dbl(lbm_par, ~ tcrossprod(.x$rho, (1-.x$pi %*% .x$con)^(.x$nr)))
```

```{r}
punif <- tb_robustness_wol %>% 
  mutate("# Std Deviation" = abs(uniform - bm.unif)/sqrt(Variance),
         "Empty Column" = (1-dens)**nr) %>% 
  dplyr::filter(nr>=10 & nc>=10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = uniform, y = bm.unif,#/(1-`Empty Column`), 
                               size = `# Std Deviation`, 
                               col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
    ggplot2::scale_size(name = latex2exp::TeX("Z_R(A)")) +
  ggplot2::xlim(c(0.5,1)) + 
  ggplot2::ylim(c(0.5,1)) +
  ggplot2::xlab(label = latex2exp::TeX("\\hat{R} Uniform")) + 
  ggplot2::ylab(label = latex2exp::TeX("\\bar{R} Uniform")) +
  ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25)+
  theme(legend.box = "horizontal")
```



```{r}
pinc_lin <- tb_robustness_wol %>% 
  mutate("# Std Deviation" = abs(uniform - bm.unif)/sqrt(Variance),
         "Empty Column" = (1-dens)**nr) %>% 
#  filter(str_sub(id, 1, 4) == "M_SD") %>% #(1-dens)**nr) %>% 
  dplyr::filter(nr>=10 & nc>=10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = increasing.lin, 
                               y = bm.inc,#,/(1-`Empty Column`), 
                               size = `# Std Deviation`, 
                               col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
  ggplot2::scale_size(name = latex2exp::TeX("Z_R(A)")) +
  ggplot2::xlab(label = latex2exp::TeX("\\hat{\\bar{R}} Linear Increasing")) + 
  ggplot2::ylab(label = latex2exp::TeX("\\bar{R} Block Increasing")) +
      ggplot2::xlim(c(0.5,1)) + 
  ggplot2::ylim(c(0.5,1)) +
 # ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25)+
  theme(legend.box = "horizontal")
```
```{r}
pdec_lin <- tb_robustness_wol %>% 
  mutate("# Std Deviation" = abs(uniform - bm.unif)/sqrt(Variance),
         "Empty Column" = (1-dens)**nr) %>% 
  dplyr::filter(nr>=10 & nc>=10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = decreasing.lin, y = bm.dec, 
                               size = `# Std Deviation`, 
                               col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
    ggplot2::scale_size(name = latex2exp::TeX("Z_R(A)")) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
  ggplot2::xlim(c(0.2,1)) + 
  ggplot2::ylim(c(0.2,1)) +
  ggplot2::xlab(label = latex2exp::TeX("\\hat{\\bar{R}} Linear Decreasing")) + 
  ggplot2::ylab(label = latex2exp::TeX("\\bar{R} Block Decreasing")) +
#  ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25)+
  theme(legend.box = "horizontal")
```

```{r}
pinc_ord <- tb_robustness_wol %>% 
  mutate("# Std Deviation" = abs(uniform - bm.unif)/sqrt(Variance),
         "Empty Column" = (1-dens)**nr) %>% 
#  filter(str_sub(id, 1, 4) == "M_SD") %>% #(1-dens)**nr) %>% 
  dplyr::filter(nr>=10 & nc>=10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = increasing, 
                               y = bm.inc,#,/(1-`Empty Column`), 
                               size = `# Std Deviation`, 
                               col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
    ggplot2::scale_size(name = latex2exp::TeX("Z_R(A)")) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
  ggplot2::xlim(c(0.5,1)) + 
  ggplot2::ylim(c(0.5,1)) +
  ggplot2::xlab(label = latex2exp::TeX("\\hat{\\bar{R}} Ordered Increasing")) + 
  ggplot2::ylab(label = latex2exp::TeX("\\bar{R} Block Increasing")) +
#  ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25)+
  theme(legend.box = "horizontal")
```
```{r}
pdec_ord <- tb_robustness_wol %>% 
  mutate("# Std Deviation" = abs(uniform - bm.unif)/sqrt(Variance),
         "Empty Column" = (1-dens)**nr) %>% 
  dplyr::filter(nr>=10 & nc>=10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = decreasing, y = bm.dec, 
                               size = `# Std Deviation`, 
                               col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
    ggplot2::scale_size(name = latex2exp::TeX("Z_R(A)")) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
  ggplot2::xlim(c(0.2,1)) + 
  ggplot2::ylim(c(0.2,1)) +
  ggplot2::xlab(label = latex2exp::TeX("\\hat{\\bar{R}} Ordered Decreasing")) + 
  ggplot2::ylab(label = latex2exp::TeX("\\bar{R} Block Decreasing")) +
#  ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25) +
  theme(legend.box = "horizontal")
```



```{r}
areas <- "AABBCCC
          AABBCCC
          DDEECCC
          DDEEFFF"
(punif |(pdec_ord/pdec_lin) | (pinc_ord/pinc_lin)) +plot_layout(guides = 'collect', widths = c(3, 2, 2.2))  & 
  theme(legend.position = 'top', legend.text = element_text(size = 9),
        legend.title = element_text(vjust = 1))
```

```{r}
areas <- "AAABBBEE
          AAABBBEE
          CCCDDDEE
          CCCDDDEE"
pdec_ord + pinc_ord + pdec_lin + pinc_lin + guide_area() +
   plot_layout(guides = 'collect', design = areas,
                 widths = c(3, 3, 2), ncol = 3, nrow = 2) 
```






```{r}
p1 <- map_dfc(rob_fun, "unif") %>% 
  mutate(`Primary Extinctions` = seq.int(0, nrow(net$net))/nrow(net$net)) %>% 
  pivot_longer(cols = - `Primary Extinctions`,
               names_to = "Net",
               values_to = "Uniform Robustness") %>% 
  ggplot(aes(`Primary Extinctions`, `Uniform Robustness`, col = Net)) +
  geom_step(linetype = "dotted", show.legend = FALSE) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_lbm_unif$fun,
           size = 1.3, alpha = .8) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_emp_unif$fun,
           size = 1, col = "blue", linetype = "dashed") +
  coord_equal() + 
  ylab("") +
  theme_minimal(base_size = 15) +
  ggtitle("Uniform")+
  theme(plot.title.position = "plot")
```

```{r}
p2 <- map_dfc(rob_fun, "dec") %>% 
  mutate(`Primary Extinctions` = seq.int(0, nrow(net$net))/nrow(net$net)) %>% 
  pivot_longer(cols = - `Primary Extinctions`,
               names_to = "Net",
               values_to = "Decreasing Robustness") %>% 
  ggplot(aes(`Primary Extinctions`, `Decreasing Robustness`, col = Net)) +
  geom_step(linetype = "dotted", show.legend = FALSE) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_lbm_dec$fun, alpha = .8,
           size = 1.3) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_emp_dec$fun,
           size = 1, col = "blue", linetype = "dashed") +
  xlab("") +
  ylab("Robustness") +
    coord_equal() + 
  theme_minimal(base_size = 15) +
  ggtitle("Decreasing") +
  theme(plot.title.position = "plot", plot.title = element_text(size = 15))#,title = element_text(hjust = 0))
```

```{r}
p3 <- map_dfc(rob_fun, "inc") %>% 
  mutate(`Primary Extinctions` = seq.int(0, nrow(net$net))/nrow(net$net)) %>% 
  pivot_longer(cols = - `Primary Extinctions`,
               names_to = "Net",
               values_to = "Increasing Robustness") %>% 
  ggplot(aes(`Primary Extinctions`, `Increasing Robustness`, col = Net)) +
  geom_step(linetype = "dotted", show.legend = FALSE) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_lbm_inc$fun,
           size = 1.3) +
  annotate("step", x = seq.int(0, nrow(net$net))/nrow(net$net), 
           y = rob_emp_inc$fun,
           size = 1, col = "blue", linetype = "dashed") +
  xlab("") +
  ylab("") +
    coord_equal() + 
  theme_minimal(base_size = 15) +
  ggtitle("Increasing")+
  theme(plot.title.position = "plot")
```

```{r}
p2 + p1 + p3
```
```{r}
tb_robustness_wol %>% 
#  mutate(BM = BM/pbiso, BM_dec = BM_dec/pbiso, BM_inc = BM_inc/pbiso) %>% 
  select(-nr, -nc, -dens, -K, -Q, -Variance) %>% 
  select(where(is.numeric) & ! contains("norm")) %>% 
  cor(use = "pairwise.complete.obs", method = "spearman") %>% 
  corrplot::corrplot()
```

We select the subset of networks where the Robustness by block model has the better
fit on the empirical Robustness:

```{r}
tb_sub <- tb_robustness_wol %>% 
  dplyr::filter((1-dens)**nr <.1 & nr > 10 & nc > 10) %>% 
  dplyr::filter(abs(uniform.emp.lin - bm.unif)/sqrt(Variance) < 1)
sub_index <- which(tb_robustness_wol$id %in% tb_sub$id)
```

```{r}
tb_sub %>% select(-nr, -nc, -dens, -K, -Q, -Variance) %>% 
  select(where(is.numeric) & ! contains("norm")) %>% 
  cor(use = "pairwise.complete.obs", method = "spearman") 
```

```{r}
if(! file.exists("wol_lbm_fixed.rds")) {
  lbm_par_fixed <- pbmcapply::pbmclapply(
    X = seq_along(web_of_life), 
    FUN = function(i) {
      llll <- NULL
      Q <- c(4, 4)
      while(is.null(llll)) {
        llll <- get_lbm_param(web_of_life[[i]]$net, model_size = Q)
        Q <- Q-1
      }
      llll <- c(llll, QR = length(llll$pi), QC = length(llll$rho))
      return(llll)
    }, mc.cores = 6L)
  saveRDS(lbm_par_fixed, "wol_lbm_fixed.rds")
}
lbm_par_fixed <- readRDS(file = "wol_lbm_fixed.rds")
```
```{r}

ext_seq <- c("uniform", "decreasing", "increasing")
tb_robustness_norm_fixed <-  pbmcapply::pbmclapply(
  X = seq_along(lbm_par_fixed), 
  FUN = function(i) {
    rob <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.00156, lbm_par_fixed[[i]][1:5])), 
                                rho = lbm_par_fixed[[i]]$rho,
                                pi = lbm_par_fixed[[i]]$pi, 
                                nr = 1000, 
                                nc = 1000,
                                ext_seq = "blocks")
    
  }, mc.cores = 10L)
tb_robustness_norm_fixed_unif <-  pbmcapply::pbmclapply(
  X = seq_along(lbm_par_fixed), 
  FUN = function(i) {
    rob <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.00156, lbm_par_fixed[[i]][1:5])), 
                                rho = lbm_par_fixed[[i]]$rho,
                                pi = lbm_par_fixed[[i]]$pi, 
                                nr = 1000, 
                                nc = 1000,
                                ext_seq = "uniform")
    
  }, mc.cores = 10L)
tb_robustness_norm_fixed_dec <-  pbmcapply::pbmclapply(
  X = seq_along(lbm_par_fixed), 
  FUN = function(i) {
    rob <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.00156, lbm_par_fixed[[i]][1:5])), 
                                rho = lbm_par_fixed[[i]]$rho,
                                pi = lbm_par_fixed[[i]]$pi, 
                                nr = 1000, 
                                nc = 1000,
                                ext_seq = "decreasing")
    
  }, mc.cores = 10L)
tb_robustness_norm_fixed_inc <-  pbmcapply::pbmclapply(
  X = seq_along(lbm_par_fixed), 
  FUN = function(i) {
    rob <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.00156, lbm_par_fixed[[i]][1:5])), 
                                rho = lbm_par_fixed[[i]]$rho,
                                pi = lbm_par_fixed[[i]]$pi, 
                                nr = 1000, 
                                nc = 1000,
                                ext_seq = "increasing")
    
  }, mc.cores = 10L)
```

```{r}
order(map_dbl(tb_robustness_norm_fixed[[3]], "auc"))
matrix(unlist(map(tb_robustness_norm_fixed[[3]], "block")), ncol = 3, byrow = TRUE)[order(map_dbl(tb_robustness_norm_fixed[[3]], "auc")),]
map_dbl(tb_robustness_norm_fixed[[3]], "auc")
map(tb_robustness_norm_fixed[[3]], "block")
lbm_par_fixed[[3]]

rob_inc <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.0156, lbm_par_fixed[[47]][1:5])),
               nr = 100, nc = 100, rho = lbm_par_fixed[[47]]$rho,
                                pi = lbm_par_fixed[[47]]$pi, ext_seq = "increasing" )$auc
 max(map_dbl(tb_robustness_norm_fixed[[3]], "auc"))
matrix(unlist(map(tb_robustness_norm_fixed[[3]], "block")), ncol = 3, byrow = TRUE)[order(map_dbl(tb_robustness_norm_fixed[[3]], "auc")),]
```

```{r}
tb_rob_order <- tibble()
for (i in seq_along(tb_robustness_norm_fixed)) {
  tb_rob_order <- bind_rows(
    tb_rob_order,
    tibble(
      dec_is_min = min(map_dbl(tb_robustness_norm_fixed[[i]], "auc")) == tb_robustness_norm_fixed_dec[[i]]$auc,      
      inc_is_max = max(map_dbl(tb_robustness_norm_fixed[[i]], "auc")) == tb_robustness_norm_fixed_inc[[i]]$auc,
      invmin_is_max = identical(map(tb_robustness_norm_fixed[[i]], "block")[[which.min(map_dbl(tb_robustness_norm_fixed[[i]], "auc"))]],
          rev(map(tb_robustness_norm_fixed[[i]], "block")[[which.max(map_dbl(tb_robustness_norm_fixed[[i]], "auc"))]])),
      rob_min = min(map_dbl(tb_robustness_norm_fixed[[i]], "auc")),
      rob_max = max(map_dbl(tb_robustness_norm_fixed[[i]], "auc"))
    ))
}
tb_rob_order <- tb_rob_order %>% mutate(unif = map_dbl(tb_robustness_norm_fixed_unif, "auc"),
                        dec = map_dbl(tb_robustness_norm_fixed_dec, "auc"),
                        inc = map_dbl(tb_robustness_norm_fixed_inc, "auc"),
                        unif_is_max = unif > rob_max) %>% 
  mutate(id = tb_robustness_wol$id, .before = everything())
colMeans(tb_rob_order[-1])
```

```{r}
tb_rob_order %>% filter(dec_is_min == FALSE | inc_is_max == FALSE | invmin_is_max == FALSE | unif_is_max == TRUE | dec> unif | inc < unif | dec > inc) %>% 
  pivot_longer(where(is.numeric)) %>% 
  ggplot(aes(x = id, y = value, col = name, fill = name, shape = name)) +
           geom_point(size = 3, alpha = .5)
```
```{r}
if (! file.exists("./tb_robustness_wol_fixed.rds"))
{
  nb_cores <- parallel::detectCores()/2
  if( is.null(nb_cores)) nb_cores <- 1
  tb_robustness_wol_fixed <- pbmcapply::pbmclapply(
    X = seq_along(web_of_life),
    FUN = function(i) {
      #      if (web_of_life[[i]]$nr + web_of_life[[i]]$nc > 1000) return(NULL)
      param <- lbm_par_fixed[[i]]
      rob_bm <- do.call(robustness_lbm, param[1:5])$auc
      rob_bm_inc <- do.call(robustness_lbm, c(param[1:5], ext_seq = "increasing"))$auc
      rob_bm_dec <- do.call(robustness_lbm, c(param[1:5], ext_seq = "decreasing"))$auc
      bm_blocks <- do.call(robustness_lbm, c(param[1:5], ext_seq = "blocks"))
      rob_bm_min <- min(map_dbl(bm_blocks, "auc"))
      rob_bm_max <- max(map_dbl(bm_blocks, "auc"))
      tb_tmp <- tibble::tibble(
        id = web_of_life[[i]]$id, 
        BM = rob_bm, 
        nr = web_of_life[[i]]$nr,
        nc = web_of_life[[i]]$nc,
        dens = web_of_life[[i]]$dens,
        BM_inc = rob_bm_inc,
        BM_dec = rob_bm_dec,
        BM_min = rob_bm_min,
        BM_max = rob_bm_max,
        K = nrow(param$con),
        Q = ncol(param$con)
      )
      return(tb_tmp)

    }, mc.cores = nb_cores
  )
  tb_robustness_wol_fixed <- dplyr::bind_rows(tb_robustness_wol_fixed)
  saveRDS(tb_robustness_wol_fixed, "./tb_robustness_wol_fixed.rds")
} else {
  tb_robustness_wol_fixed <- readRDS(file = "./tb_robustness_wol_fixed.rds")
}
```

```{r}
tb_robustness_wol_fixed %>% 
  mutate(Empirical = tb_robustness_wol$Empirical,
         emp_dec = tb_robustness_wol$emp_dec,
         emp_inc = tb_robustness_wol$emp_inc) 
  mutate("Empty Column" = (1-dens)**nr) %>% 
  dplyr::filter(nr>10 & nc>10) %>% 
  ggplot2::ggplot(ggplot2::aes(x = emp_inc, y = BM_inc, 
                                      col = `Empty Column`)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) + 
  ggplot2::geom_point(alpha = .5) +
  ggplot2::scale_color_gradient( low = "grey50", high = "red") +
  ggplot2::xlim(c(0.5,1)) + 
  ggplot2::ylim(c(0.5,1)) +
  ggplot2::xlab(label = "AUC(R) by Monte Carlo") + 
  ggplot2::ylab(label = "AUC(R) by LBM Expectation") +
  ggplot2::coord_fixed() +
  ggplot2::theme_minimal(base_size = 15, base_rect_size = .25)

tb_robustness_wol_fixed %>% 
  mutate(Empirical = tb_robustness_wol$Empirical,
         emp_dec = tb_robustness_wol$emp_dec,
         emp_inc = tb_robustness_wol$emp_inc) %>% 
  select(Empirical, BM, emp_dec, BM_dec, emp_inc, BM_inc, BM_min, BM_max) %>% 
  cor(method = "spearman")
  
```
```{r}
indexunif <- with(tb_rob_order, which(( dec> unif | inc < unif | dec > inc)))

map(indexunif, function(i) lbm_par_fixed[[i]])
# Tous ces réseaux ont une structure assortative, très inhabituel. Mais non détecté par l'ICL
tb_robustness_wol[indexunif,] %>% select(id, nr, nc, dens, K, Q,  emp_dec, Empirical, emp_inc)
# 
indexdecmin <- with(tb_rob_order, which(dec_is_min == FALSE ))
indexincmax <- with(tb_rob_order, which((inc_is_max == FALSE )))
indexinv <- with(tb_rob_order, which((invmin_is_max == FALSE )))

map(indexdecmin, function(i) lbm_par_fixed[[i]])
map(indexincmax, function(i) lbm_par_fixed[[i]])

tb_rob_order[indexdecmin,] %>% select(id, rob_min, dec, unif, inc, rob_max)
tb_rob_order[indexincmax,] %>% select(id, rob_min, dec, unif, inc, rob_max)
tb_robustness_wol[indexincmax,] %>% select(id, nr, nc, dens, K, Q,  emp_dec, Empirical, emp_inc)
tb_robustness_wol[indexinv,] %>% select(id, nr, nc, dens, K, Q,  emp_dec, Empirical, emp_inc)

tb_robustness_wol[] %>% 
  filter(id %in% c("M_PL_026", "M_PL_046", "M_PL_072_01", "M_SD_031", "A_HP_031", "A_HP_050", "M_PL_004")) %>% 
  select(id, nr, nc, dens, K, Q,  emp_dec, Empirical, emp_inc)

res <- robustness_lbm(con = do.call(robber:::normalize_lbm_con, c(dens = 0.0156, lbm_par_fixed[[6]][1:5])), 
                                rho = lbm_par_fixed[[6]]$rho,
                                pi = lbm_par_fixed[[6]]$pi, 
                                nr = 100, 
                                nc = 100,
                                ext_seq = "decreasing")
ggplot(tibble(x = seq(0,  100), y = res$fun), aes (x = x, y = y)) +
  geom_line()
```

```{r comp_na_pred}
if (!file.exists("tb_na_pred.rds")) {
  nb_cores <- parallel::detectCores()/2
  if( is.null(nb_cores)) nb_cores <- 1
  tb_na_pred <- lapply(
    X = seq_along(web_of_life),
    FUN = function(i) {
      # if (! web_of_life[[i]]$id %in% 
      #     c(tb_sub$id,
      #       paste(strsplit(web_of_life[[i]]$id, NULL)[[1]][c(1:2,4:3, 5:length(strsplit(web_of_life[[i]]$id, NULL)[[1]]))], collapse=''))) return(NULL)
      if (! web_of_life[[i]]$id %in% tb_sub$id) return(NULL)
      res <- pbmcapply::pbmclapply(
        X = seq(30),
        FUN = function(iter) {
          A_tmp <- web_of_life[[i]]$net
          trans1 <- sample(seq(3), nrow(A_tmp), replace = TRUE, 
                           prob = c(.50, .25, .25))
          trans2 <- sample(seq(3), ncol(A_tmp), replace = TRUE, 
                           prob = c(.50, .25, .25))
          A_tmp[trans1 == 2, trans2 == 3] <- NA
          A_tmp[trans1 == 3, trans2 == 2] <- NA
          par <- get_lbm_param(A_tmp)    
          return( 
            list(bm_unif = do.call(robustness_lbm, c(par, ext_seq = "uniform"))$auc,
                 bm_dec = do.call(robustness_lbm, c(par, ext_seq = "decreasing"))$auc,
                 bm_inc = do.call(robustness_lbm, c(par, ext_seq = "increasing"))$auc,
                 bm_dec.exp = do.call(robustness_lbm, c(par, ext_seq = "decreasing", method = "expected"))$auc,
                 bm_inc.exp = do.call(robustness_lbm, c(par, ext_seq = "increasing", method = "expected"))$auc,
                 mc_unif = robustness_emp(A_tmp, ext_seq = "uniform")$auc,
                 mc_dec.ord = robustness_emp(A_tmp, ext_seq = "decreasing", method = "ordered")$auc,
                 mc_inc.ord = robustness_emp(A_tmp, ext_seq = "increasing", method = "ordered")$auc,
                 mc_dec.lin = robustness_emp(A_tmp, ext_seq = "decreasing", method = "linear")$auc,
                 mc_inc.lin = robustness_emp(A_tmp, ext_seq = "increasing", method = "linear")$auc))      
        }, mc.cores = nb_cores)
      rob <-  bind_rows(res) %>% mutate(id = web_of_life[[i]]$id, .before = "bm_unif")
      return(rob
        # tibble::tibble(
        #   id = rob$id,
        #   rmse_bm_unif = mean((purrr::map_dbl(res, "bm_unif") - rob$uniform.emp.lin)**2),
        #   rmse_bm_dec = mean((purrr::map_dbl(res, "bm_dec") - rob$bm.dec)**2),
        #   rmse_bm_inc = mean((purrr::map_dbl(res, "bm_inc") - rob$bm.inc)**2),           
        #   rmse_mc_unif = mean((purrr::map_dbl(res, "mc_unif")- rob$uniform.emp.lin)**2),
        #   rmse_mc_dec = mean((purrr::map_dbl(res, "mc_dec") - rob$decreasing.emp.lin)**2),
        #   rmse_mc_inc = mean((purrr::map_dbl(res, "mc_inc") - rob$decreasing.emp.lin)**2),
        #   mean_bm_unif = mean(purrr::map_dbl(res, "bm_unif")),
        #   sd_bm_unif = sd(purrr::map_dbl(res, "bm_unif")),
        #   mean_bm_dec = mean(purrr::map_dbl(res, "bm_dec")),
        #   sd_bm_dec = sd(purrr::map_dbl(res, "bm_dec")),
        #   mean_bm_inc = mean(purrr::map_dbl(res, "bm_inc")),
        #   sd_bm_inc = sd(purrr::map_dbl(res, "bm_inc")),
        #   mean_mc_unif = mean(purrr::map_dbl(res, "mc_unif")),
        #   sd_mc_unif = sd(purrr::map_dbl(res, "mc_unif")),
        #   mean_mc_dec = mean(purrr::map_dbl(res, "mc_dec")),
        #   sd_mc_dec = sd(purrr::map_dbl(res, "mc_dec")),
        #   mean_mc_inc = mean(purrr::map_dbl(res, "mc_inc")),
        #   sd_mc_inc = sd(purrr::map_dbl(res, "mc_inc"))
        # )
      )
    })#, mc.cores = nb_cores)
  tb_na_pred <- dplyr::bind_rows(tb_na_pred)
  saveRDS(tb_na_pred, file = "tb_na_pred.rds")
} else {
  tb_na_pred <- readRDS(file = "./tb_na_pred.rds")
}
```

```{r}
p1 <- tb_na_pred %>% 
  group_by(id) %>% 
  summarise(
          rmse_bm_unif = mean((bm_unif - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.unif)**2),
          # rmse_bmemp_unif = mean((bm_unif - tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform)**2),
          rmse_bm_dec  = mean((bm_dec - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.dec)**2),
          rmse_bm_inc  = mean((bm_inc - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.inc)**2),
          rmse_em_unif = mean((mc_unif- tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform)**2),
          rmse_mc_dec  = mean((mc_dec.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.lin)**2),
          rmse_mc_inc  = mean((mc_inc.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.lin)**2),
          rmse_or_dec  = mean((mc_dec.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing)**2),
          rmse_or_inc  = mean((mc_inc.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing)**2)) %>% 
  mutate(Experiment = "NA Interactions") %>% 
#  bind_rows(tb_na_pred %>% mutate(Experiment = "NA Interactions")) %>%
  select(starts_with("rmse"), starts_with("Experiment")) %>% 
  pivot_longer(cols = starts_with("rmse"),
               names_to = c("Method", "Extinction"),
               names_sep = 8,
               values_to = "RMSE") %>% 
  mutate(Method = case_when(
    str_sub(Method, 6, 7) == "bm" ~ "Block Model",
    str_sub(Method, 6, 7) == "mc" ~ "Linear Monte Carlo",
    str_sub(Method, 6, 7) == "or" ~ "Ordered Monte Carlo",
    str_sub(Method, 6, 7) == "em" ~ "Monte Carlo")) %>%
  mutate(`Primary Extinction Sequences` = case_when(
    Extinction == "inc" ~ "Increasing",
    Extinction == "dec" ~ "Decreasing",
    Extinction == "unif" ~ "Uniform")) %>%
  mutate(RMSE = sqrt(RMSE)) %>% 
  ggplot(aes(x = `Primary Extinction Sequences`, y = RMSE, fill = Method)) +
  facet_wrap(~ Experiment) +
  geom_boxplot() +
  theme_minimal(base_size = 15, base_rect_size = .25) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 18))
```



## Application on networks with missing species

In the next application, we use the same set of networks and assume that only a
fraction of the species were observed (75% on average). 
We also assume that there exists some expert knowledge that brings us 
information about the size of each network and its density (connectance).

```{r comp_missing_spec_pred}
if (!file.exists("tb_missing_species_pred.rds")) {
  nb_cores <- parallel::detectCores()/2
  if( is.null(nb_cores)) nb_cores <- 1
  tb_missing_species_pred <- lapply(
    X = seq_along(web_of_life),
    FUN = function(i) {
      if (! web_of_life[[i]]$id %in% tb_sub$id) return(NULL)
      res <- pbmcapply::pbmclapply(
        X = seq(30),
        FUN = function(iter) {
          A_tmp <- web_of_life[[i]]$net
          A_tmp <- A_tmp[sample(seq.int(nrow(A_tmp)), round(nrow(A_tmp)*.75)),
                         sample(seq.int(ncol(A_tmp)), round(ncol(A_tmp)*.75))]
          par <- get_lbm_param(A_tmp) 
          par$con <- robber:::normalize_lbm_con(dens = mean(web_of_life[[i]]$net),
                                                con = par$con, 
                                                pi = par$pi,
                                                rho = par$rho)
          par$nr <- nrow(web_of_life[[i]]$net)
          par$nc <- ncol(web_of_life[[i]]$net)
          return( 
            list(bm_unif = do.call(robustness_lbm, c(par, ext_seq = "uniform"))$auc,
                 bm_dec = do.call(robustness_lbm, c(par, ext_seq = "decreasing"))$auc,
                 bm_inc = do.call(robustness_lbm, c(par, ext_seq = "increasing"))$auc,
                 bm_dec.exp = do.call(robustness_lbm, c(par, ext_seq = "decreasing", method = "expected"))$auc,
                 bm_inc.exp = do.call(robustness_lbm, c(par, ext_seq = "increasing", method = "expected"))$auc,
                 mc_unif = robustness_emp(A_tmp, ext_seq = "uniform")$auc,
                 mc_dec.ord = robustness_emp(A_tmp, ext_seq = "decreasing", method = "ordered")$auc,
                 mc_inc.ord = robustness_emp(A_tmp, ext_seq = "increasing", method = "ordered")$auc,
                 mc_dec.lin = robustness_emp(A_tmp, ext_seq = "decreasing", method = "linear")$auc,
                 mc_inc.lin = robustness_emp(A_tmp, ext_seq = "increasing", method = "linear")$auc))      
        }, mc.cores = nb_cores)
      rob <-  bind_rows(res) %>% mutate(id = web_of_life[[i]]$id, .before = "bm_unif")
      return(rob)
    })#, mc.cores = nb_cores)
  tb_missing_species_pred <- dplyr::bind_rows(tb_missing_species_pred)
  saveRDS(tb_missing_species_pred, file = "tb_missing_species_pred.rds")
} else {
  tb_missing_species_pred <- readRDS(file = "./tb_missing_species_pred.rds")
}
```

```{r}
p2 <-
  tb_missing_species_pred %>% 
  group_by(id) %>% 
  summarise(
    rmse_bm_unif = mean((bm_unif - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.unif)**2),
    rmse_bm_dec  = mean((bm_dec - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.dec)**2),
    rmse_bm_inc  = mean((bm_inc - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.inc)**2),
    rmse_em_unif = mean((mc_unif- tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform)**2),
    rmse_mc_dec  = mean((mc_dec.lin   - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.lin)**2),
    rmse_mc_inc  = mean((mc_inc.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.lin)**2), 
  rmse_or_dec  = mean((mc_dec.ord   -
                         tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing)**2),
rmse_or_inc  = mean((mc_inc.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing)**2)) %>% 
  mutate(Experiment = "Missing Species") %>% 
#  bind_rows(tb_na_pred %>% mutate(Experiment = "NA Interactions")) %>%
  select(starts_with("rmse"), starts_with("Experiment")) %>% 
  pivot_longer(cols = starts_with("rmse"),
               names_to = c("Method", "Extinction"),
               names_sep = 8,
               values_to = "RMSE") %>% 
  mutate(Method = case_when(
    str_sub(Method, 6, 7) == "bm" ~ "Block Model",
    str_sub(Method, 6, 7) == "mc" ~ "Linear Monte Carlo",
    str_sub(Method, 6, 7) == "or" ~ "Ordered Monte Carlo",
    str_sub(Method, 6, 7) == "em" ~ "Monte Carlo")) %>%
  mutate(`Primary Extinction Sequences` = case_when(
    Extinction == "inc" ~ "Increasing",
    Extinction == "dec" ~ "Decreasing",
    Extinction == "unif" ~ "Uniform")) %>%
  mutate(RMSE = sqrt(RMSE)) %>% 
  ggplot(aes(x = `Primary Extinction Sequences`, y = RMSE, fill = Method)) +
  facet_wrap(~ Experiment) +
  geom_boxplot() +
  theme_minimal(base_size = 15, base_rect_size = .25) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 18))
```


```{r}
tb_na_pred %>% 
  group_by(id) %>% 
  summarise(
          rmse_bm_unif = mean((bm_unif - tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform.emp.lin)**2),
          rmse_bm_dec  = mean((bm_dec - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.dec)**2),
          rmse_bm_inc  = mean((bm_inc - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.inc)**2),
          rmse_mc_unif = mean((mc_unif- tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform.emp.lin)**2),
          rmse_mc_dec  = mean((mc_dec.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.emp.lin)**2),
          rmse_mc_inc  = mean((mc_inc.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.emp.lin)**2),
          rmse_or_dec  = mean((mc_dec.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.emp.ord)**2),
          rmse_or_inc  = mean((mc_inc.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.emp.ord)**2)          ) %>% 
  mutate(Experiment = "NA Interactions") %>% 
#  bind_rows(tb_na_pred %>% mutate(Experiment = "NA Interactions")) %>%
  bind_rows( tb_missing_species_pred %>% 
               group_by(id) %>% 
  summarise(
          rmse_bm_unif = mean((bm_unif - tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform.emp.lin)**2),
          rmse_bm_dec  = mean((bm_dec - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.dec)**2),
          rmse_bm_inc  = mean((bm_inc - tb_robustness_wol[tb_robustness_wol$id %in% id,]$bm.inc)**2),
          rmse_mc_unif = mean((mc_unif- tb_robustness_wol[tb_robustness_wol$id %in% id,]$uniform.emp.lin)**2),
          rmse_mc_dec  = mean((mc_dec.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.emp.lin)**2),
          rmse_mc_inc  = mean((mc_inc.lin - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.emp.lin)**2),
          rmse_or_dec  = mean((mc_dec.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$decreasing.emp.ord)**2),
          rmse_or_inc  = mean((mc_inc.ord - tb_robustness_wol[tb_robustness_wol$id %in% id,]$increasing.emp.ord)**2)          ) %>% 
  mutate(Experiment = "Missing Species")) %>% 
  select(starts_with("rmse"), starts_with("Experiment")) %>% 
  pivot_longer(cols = starts_with("rmse"),
               names_to = c("Method", "Extinction"),
               names_sep = 8,
               values_to = "RMSE") %>% 
  mutate(Method = case_when(
    str_sub(Method, 6, 7) == "bm" ~ "Block Model",
    str_sub(Method, 6, 7) == "mc" ~ "Linear Monte Carlo",
    str_sub(Method, 6, 7) == "or" ~ "Ordered Monte Carlo",)) %>%
  mutate(`Extinctions Sequences` = case_when(
    Extinction == "inc" ~ "Increasing",
    Extinction == "dec" ~ "Decreasing",
    Extinction == "unif" ~ "Uniform")) %>%
  mutate(RMSE = sqrt(RMSE)) %>% 
  ggplot(aes(x = `Extinctions Sequences`, y = RMSE, fill = Method)) +
  facet_wrap(~ Experiment) +
  geom_boxplot() +
  theme_bw(base_size = 15)

```

```{r}
tb_missing_species_pred %>% 
  mutate(Experiment = "Missing Species") %>% 
  bind_rows(tb_na_pred %>% mutate(Experiment = "NA Interactions")) %>%
  select(starts_with("bm"), starts_with("mc"), !ends_with("exp")) %>% 
  pivot_longer(cols = where(is.numeric),
               names_to = c("Method", "Extinction"),
               names_sep = "_",
               values_to = "RMSE") %>% 
  mutate(Method = case_when(
    str_sub(Method, 6, 7) == "bm" ~ "Block Model",
    str_sub(Method, 6, 7) == "mc" ~ "Monte Carlo")) %>%
  mutate(`Extinctions Sequences` = case_when(
    Extinction == "inc" ~ "Increasing",
    Extinction == "dec" ~ "Decreasing",
    Extinction == "unif" ~ "Uniform")) %>%
  filter(! is.na(`Extinctions Sequences`)) %>% 
  mutate(RMSE = sqrt(RMSE)) %>% 
  facet_wrap(~ Experiment) +
  geom_boxplot() +
  theme_classic(base_size = 15)
```

```{r}
library(patchwork)
(p1 + p2  + guide_area()) +
    plot_layout(guides = 'collect', widths = c(3, 3, 1.5))
ggsave(filename = "prediction2.png", path = "~/Documents/robustness/robustness/image/",
       width = 10, height = 4)
   # , design = areas,
   #               widths = c(3, 3, 1), ncol = 3, nrow = 1) 
```

